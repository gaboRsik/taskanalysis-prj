<div class="container-fluid mt-4">
  <!-- Active Timer Alert -->
  <div *ngIf="activeTimer" class="alert alert-info d-flex justify-content-between align-items-center mb-4">
    <div>
      <strong><i class="bi bi-stopwatch"></i> Active Timer:</strong>
      {{ activeTimer.taskTitle }} - {{ activeTimer.subtaskTitle }}
      <span class="badge bg-primary ms-2">{{ elapsedTime }}</span>
    </div>
    <button class="btn btn-danger btn-sm" (click)="stopTimer()">
      <i class="bi bi-stop-circle"></i> Stop Timer
    </button>
  </div>

  <div class="row">
    <!-- Task Selector Sidebar -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-list-check"></i> Select Task</h5>
        </div>
        <div class="card-body">
          <select
            class="form-select mb-3"
            [(ngModel)]="selectedTaskId"
            (change)="onTaskChange()"
          >
            <option [ngValue]="null">-- Select a task --</option>
            <option *ngFor="let task of tasks" [ngValue]="task.id">
              {{ task.name }}
            </option>
          </select>

          <div *ngIf="selectedTask" class="mt-3">
            <div class="alert alert-light">
              <strong>Status:</strong>
              <span
                class="badge ms-2"
                [class.bg-secondary]="selectedTask.status === TaskStatus.NOT_STARTED"
                [class.bg-warning]="selectedTask.status === TaskStatus.IN_PROGRESS"
                [class.bg-success]="selectedTask.status === TaskStatus.COMPLETED"
              >
                {{ selectedTask.status }}
              </span>
            </div>
            <div class="alert alert-light">
              <strong>Subtasks:</strong>
              <span class="badge bg-primary ms-2">{{ selectedTask.subtasks.length }}</span>
            </div>
          </div>
        </div>
      </div>

<!--      <div class="card mt-3">-->
<!--        <div class="card-body text-center">-->
<!--          <p class="text-muted mb-2">-->
<!--            <i class="bi bi-info-circle"></i> Need to manage tasks?-->
<!--          </p>-->
<!--          <a routerLink="/tasks" class="btn btn-outline-primary btn-sm w-100">-->
<!--            <i class="bi bi-list-task"></i> Go to Tasks-->
<!--          </a>-->
<!--        </div>-->
<!--      </div>-->
    </div>

    <!-- Main Content - Subtasks -->
    <div class="col-md-9">
      <div *ngIf="!selectedTask" class="card">
        <div class="card-body text-center py-5">
          <i class="bi bi-arrow-left-circle display-1 text-muted"></i>
          <h4 class="mt-3 text-muted">Select a task from the left to start time tracking</h4>
          <p class="text-muted">Choose a task to view and manage its subtasks</p>
        </div>
      </div>

      <div *ngIf="selectedTask" class="card mb-3">
        <div class="card-header bg-gradient">
          <h5 class="mb-0">
            <i class="bi bi-bar-chart-fill"></i> Time Analysis
          </h5>
          <small class="text-muted">Total time spent per subtask</small>
        </div>
        <div class="card-body">
          <div *ngIf="chartData.length === 0" class="alert alert-info">
            <i class="bi bi-info-circle"></i> No time data available yet. Start tracking time on subtasks!
          </div>
          <div *ngIf="chartData.length > 0" style="width: 100%; height: 400px;">
            <ngx-charts-bar-vertical
              [results]="chartData"
              [xAxis]="showXAxis"
              [yAxis]="showYAxis"
              [legend]="showLegend"
              [showXAxisLabel]="showXAxisLabel"
              [showYAxisLabel]="showYAxisLabel"
              [xAxisLabel]="xAxisLabel"
              [yAxisLabel]="yAxisLabel"
              [scheme]="colorScheme"
              [animations]="animations"
              [yScaleMin]="0"
              [barPadding]="8"
              [roundDomains]="false">
            </ngx-charts-bar-vertical>
          </div>
        </div>
      </div>

      <div *ngIf="selectedTask" class="card">
        <div class="card-header bg-gradient">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0">
                <i class="bi bi-check2-square"></i> {{ selectedTask.name }}
              </h5>
              <small class="text-muted">
                Time Tracking & Subtasks
                <span *ngIf="selectedTask.totalPlannedPoints || selectedTask.totalActualPoints" class="ms-2">
                  | <i class="bi bi-star"></i> Points: 
                  <strong>{{ selectedTask.totalActualPoints || 0 }}</strong> / {{ selectedTask.totalPlannedPoints || 0 }}
                  <span *ngIf="selectedTask.totalPlannedPoints && selectedTask.totalPlannedPoints > 0" class="badge bg-info ms-1">
                    {{ ((selectedTask.totalActualPoints || 0) / selectedTask.totalPlannedPoints * 100).toFixed(0) }}%
                  </span>
                </span>
              </small>
            </div>
            <button 
              class="btn btn-sm btn-outline-info" 
              (click)="openPointsModal()"
              title="Edit subtask points"
            >
              <i class="bi bi-pencil-square"></i> Edit Points
            </button>
          </div>
        </div>
        <div class="card-body">
          <div *ngIf="!selectedTask.subtasks || selectedTask.subtasks.length === 0" class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> No subtasks found for this task.
          </div>

          <div class="list-group">
            <div
              *ngFor="let subtask of selectedTask.subtasks"
              class="list-group-item"
            >
              <div class="d-flex justify-content-between align-items-center">
                <div class="flex-grow-1">
                  <h6 class="mb-1">
                    <i class="bi bi-circle-fill me-2"
                       [class.text-secondary]="subtask.status === 'NOT_STARTED'"
                       [class.text-warning]="subtask.status === 'IN_PROGRESS'"
                       [class.text-success]="subtask.status === 'COMPLETED'"
                       style="font-size: 0.6rem;">
                    </i>
                    Subtask #{{ subtask.subtaskNumber }}
                  </h6>
                  <div class="d-flex gap-3 mt-2">
                    <span class="badge bg-light text-dark">
                      <i class="bi bi-bar-chart"></i> Planned: {{ subtask.plannedPoints || 0 }}
                    </span>
                    <span *ngIf="subtask.actualPoints && subtask.actualPoints > 0" class="badge bg-info">
                      <i class="bi bi-check-circle"></i> Actual: {{ subtask.actualPoints }}
                    </span>
                    <span
                      class="badge"
                      [class.bg-secondary]="subtask.status === 'NOT_STARTED'"
                      [class.bg-warning]="subtask.status === 'IN_PROGRESS'"
                      [class.bg-success]="subtask.status === 'COMPLETED'"
                    >
                      {{ subtask.status }}
                    </span>
                  </div>
                </div>
                <div>
                  <button
                    class="btn"
                    [class.btn-primary]="!activeTimer || activeTimer.subtaskId !== subtask.id"
                    [class.btn-danger]="activeTimer?.subtaskId === subtask.id"
                    [class.btn-lg]="activeTimer?.subtaskId === subtask.id"
                    (click)="activeTimer?.subtaskId === subtask.id ? stopTimer() : startTimer(subtask.id)"
                  >
                    <i
                      class="bi me-1"
                      [class.bi-play-circle-fill]="!activeTimer || activeTimer.subtaskId !== subtask.id"
                      [class.bi-stop-circle-fill]="activeTimer?.subtaskId === subtask.id"
                    ></i>
                    {{ activeTimer?.subtaskId === subtask.id ? 'Stop' : 'Start' }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Points Modal -->
<app-subtask-points-modal
  [task]="selectedTask"
  [isOpen]="isPointsModalOpen"
  (close)="closePointsModal()"
  (save)="saveSubtaskPoints($event)">
</app-subtask-points-modal>
